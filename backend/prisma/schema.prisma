// STIA CRM - Prisma Schema
// Modelo de datos simplificado para MVP

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==================== USER & AUTH ====================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  phone     String?
  avatar    String?

  // Role
  roleId    String
  role      Role     @relation(fields: [roleId], references: [id])

  // Geographic scope
  country   String?  // CountryCode (CR, GT, SV, HN, PA) for Gerente scope
  regionId  String?  // For Regional scope
  region    Region?  @relation(fields: [regionId], references: [id])

  // Supervisor hierarchy
  supervisorId String?
  supervisor   User?   @relation("UserSupervisor", fields: [supervisorId], references: [id])
  subordinates User[]  @relation("UserSupervisor")

  // SAP reference
  sapSalesPersonCode Int?  // SalesEmployeeCode from SAP

  // Team
  teamId    String?
  team      Team?    @relation(fields: [teamId], references: [id])

  // Status
  isActive  Boolean  @default(true)

  // Timestamps
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Ownership relations
  ownedContacts      Contact[]      @relation("ContactOwner")
  ownedAccounts      Account[]      @relation("AccountOwner")
  ownedOpportunities Opportunity[]  @relation("OpportunityOwner")
  activities         Activity[]     @relation("ActivityOwner")
  ownedLeads         Lead[]         @relation("LeadOwner")
  ownedQuotes        Quote[]        @relation("QuoteOwner")
  ownedOrders        Order[]        @relation("OrderOwner")
  ownedCases         Case[]         @relation("CaseOwner")

  @@index([email])
  @@index([roleId])
  @@index([isActive])
  @@index([supervisorId])
  @@index([country])
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  permissions Json     // { module: string, actions: string[] }[]
  isSystem    Boolean  @default(false)

  // Data scope level determines what data users with this role can see
  // OWN = only their records, TEAM = their subordinates' records,
  // COUNTRY = all records in their country, REGION = all countries in their region,
  // ALL = everything (admin)
  scopeLevel  String   @default("OWN") // OWN, TEAM, COUNTRY, REGION, ALL

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       User[]
}

model Region {
  id          String   @id @default(uuid())
  name        String   @unique  // e.g. "Centroamérica Norte", "Centroamérica Sur"
  countries   String[] // Array of CountryCodes: ["CR", "PA"]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       User[]
}

model Team {
  id          String   @id @default(uuid())
  name        String
  description String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members     User[]
}

// ==================== CRM ENTITIES ====================

model Lead {
  id          String   @id @default(uuid())
  firstName   String
  lastName    String
  company     String?
  email       String?
  phone       String?
  source      String?  // Web, Referral, Partner, etc.
  
  // Qualification
  status      String   @default("NEW") // NEW, CONTACTED, QUALIFIED, DISQUALIFIED
  rating      String?  // HOT, WARM, COLD
  
  // Qualification (BANT & Details)
  budget      Float?
  currency    String   @default("USD")
  authority   Boolean  @default(false) // Decision Maker?
  need        String?  // Description of Need
  timeframe   String?  // <1 Month, 1-3 Months, etc.
  
  // Person Details
  jobTitle    String?
  industry    String?
  sourceDetail String? // e.g. "Google Ads", "Referral: John Doe"
  
  // Assignment
  isAssigned  Boolean  @default(false)
  assignedAt  DateTime?
  
  // Details
  notes       String?
  
  // Relations
  ownerId     String
  owner       User     @relation("LeadOwner", fields: [ownerId], references: [id])
  
  // Conversion
  convertedAccountId     String?
  convertedContactId    String?
  convertedOpportunityId String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([email])
  @@index([status])
  @@index([ownerId])
}

model Contact {
  id        String   @id @default(uuid())
  firstName String
  lastName  String
  email     String?
  phone     String?
  mobile    String?
  jobTitle  String?

  // Marketing
  leadSource String?
  tags       String[]

  // Relations
  accountId  String?
  account    Account? @relation(fields: [accountId], references: [id])

  ownerId    String
  owner      User     @relation("ContactOwner", fields: [ownerId], references: [id])

  // Status
  isActive   Boolean  @default(true)

  // Timestamps
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Reverse relations
  opportunities Opportunity[]
  activities    Activity[]
  quotes        Quote[]
  orders        Order[]
  cases         Case[]

  @@index([email])
  @@index([accountId])
  @@index([ownerId])
  @@index([isActive])
}

model Account {
  id           String   @id @default(uuid())
  name         String
  industry     String?
  accountType  String?
  website      String?
  phone        String?
  sapId        String?  // Reference to SAP Business Partner
  country      String?  // Added for Excel Data

  // Relations
  ownerId      String
  owner        User     @relation("AccountOwner", fields: [ownerId], references: [id])

  // Status
  isActive     Boolean  @default(true)

  // Timestamps
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Reverse relations
  contacts      Contact[]
  opportunities Opportunity[]
  activities    Activity[]
  quotes        Quote[]
  orders        Order[]
  invoices      Invoice[]
  cases         Case[]

  @@index([name])
  @@index([ownerId])
  @@index([isActive])
}

model Product {
  id          String   @id @default(uuid())
  name        String
  code        String   @unique // SAP ItemCode
  description String?
  category    String?
  
  price       Float    @default(0)
  currency    String   @default("USD")
  
  stockLevel  Int      @default(0)
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  quoteItems  QuoteItem[]
  orderItems  OrderItem[]
}

model Opportunity {
  id          String   @id @default(uuid())
  name        String
  amount      Float
  currency    String   @default("USD")

  // Pipeline
  // Pipeline (Stage 6-10 mapped to 11-step process)
  // 6. OPPORTUNITY (From Conversion)
  // 7. PROPOSAL (Quote Sent)
  // 8. FOLLOW_UP (Active Engagement)
  // 9. NEGOTIATION (Terms)
  // 10. CLOSED_WON (Order Created)
  // 11. CLOSED_LOST
  stage       String   @default("OPPORTUNITY")
  probability Int

  // Timing
  closeDate   DateTime

  // Relations
  accountId   String
  account     Account  @relation(fields: [accountId], references: [id])

  contactId   String?
  contact     Contact? @relation(fields: [contactId], references: [id])

  ownerId     String
  owner       User     @relation("OpportunityOwner", fields: [ownerId], references: [id])

  // Status
  isClosed    Boolean  @default(false)
  isWon       Boolean?

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Reverse relations
  activities  Activity[]
  quotes      Quote[]
  orders      Order[]

  @@index([accountId])
  @@index([contactId])
  @@index([ownerId])
  @@index([stage])
  @@index([closeDate])
  @@index([isClosed])
}

model Quote {
  id             String   @id @default(uuid())
  quoteNumber    String   @unique
  name           String
  
  // Financials
  totalAmount    Float
  currency       String   @default("USD")
  
  // Status
  status         String   @default("DRAFT") // DRAFT, SENT, ACCEPTED, REJECTED
  lossReason     String?  // Added for Excel Data
  
  // Dates
  expirationDate DateTime?
  
  // Relations
  opportunityId  String?
  opportunity    Opportunity? @relation(fields: [opportunityId], references: [id])
  
  accountId      String
  account        Account  @relation(fields: [accountId], references: [id])
  
  contactId      String?
  contact        Contact? @relation(fields: [contactId], references: [id])
  
  ownerId        String
  owner          User     @relation("QuoteOwner", fields: [ownerId], references: [id])
  
  items          QuoteItem[]
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@index([quoteNumber])
  @@index([status])
  @@index([accountId])
  @@index([ownerId])
}

model QuoteItem {
  id          String   @id @default(uuid())
  quoteId     String
  quote       Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  
  quantity    Int
  unitPrice   Float
  totalPrice  Float
  discount    Float    @default(0)

  @@index([quoteId])
  @@index([productId])
}

model Order {
  id             String   @id @default(uuid())
  orderNumber    String   @unique
  sapOrderId     String?  // Reference to SAP Order
  
  // Financials
  totalAmount    Float
  currency       String   @default("USD")
  
  // Logistics Status
  status          String   @default("PENDING") // PENDING, PROCESSING, SHIPPED, DELIVERED, CANCELLED
  logisticsStatus String?  // "Facturado", "Disponible", "Salió de puerto", "Llegó a puerto"
  trackingNumber  String?
  
  // Relations
  opportunityId  String?
  opportunity    Opportunity? @relation(fields: [opportunityId], references: [id])
  
  accountId      String
  account        Account  @relation(fields: [accountId], references: [id])
  
  contactId      String?
  contact        Contact? @relation(fields: [contactId], references: [id])
  
  ownerId        String
  owner          User     @relation("OrderOwner", fields: [ownerId], references: [id])
  
  items          OrderItem[]
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@index([orderNumber])
  @@index([status])
  @@index([accountId])
  @@index([ownerId])
}

model OrderItem {
  id          String   @id @default(uuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  
  quantity    Int
  unitPrice   Float
  totalPrice  Float
  discount    Float    @default(0)

  @@index([orderId])
  @@index([productId])
}

model Invoice {
  id          String   @id @default(uuid())
  invoiceNumber String @unique
  sapInvoiceId  String?
  
  amount      Float
  status      String   @default("UNPAID") // UNPAID, PARTIAL, PAID, OVERDUE
  
  dueDate     DateTime
  paidDate    DateTime?
  
  accountId   String
  account     Account? @relation(fields: [accountId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([accountId])
  @@index([status])
  @@index([dueDate])
}

model Case {
  id          String   @id @default(uuid())
  caseNumber  String   @unique
  title       String
  description String?
  
  // Classification
  priority    String   @default("NORMAL") // LOW, NORMAL, HIGH, CRITICAL
  status      String   @default("NEW")    // NEW, IN_PROGRESS, RESOLVED, CLOSED
  origin      String?  // PHONE, EMAIL, WEB
  
  // Relations
  accountId   String?
  account     Account? @relation(fields: [accountId], references: [id])
  
  contactId   String?
  contact     Contact? @relation(fields: [contactId], references: [id])
  
  ownerId     String
  owner       User     @relation("CaseOwner", fields: [ownerId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([caseNumber])
  @@index([status])
  @@index([ownerId])
  @@index([accountId])
}

model Activity {
  id           String    @id @default(uuid())
  activityType String    // 'Call', 'Email', 'Meeting', 'Task', 'Note'
  subject      String
  description  String?

  // Timing
  dueDate      DateTime?

  // Status
  status       String    // 'Planned', 'Completed', 'Cancelled'
  priority     String?

  // Relations
  contactId    String?
  contact      Contact?  @relation(fields: [contactId], references: [id])

  accountId    String?
  account      Account?  @relation(fields: [accountId], references: [id])

  opportunityId String?
  opportunity   Opportunity? @relation(fields: [opportunityId], references: [id])

  ownerId      String
  owner        User      @relation("ActivityOwner", fields: [ownerId], references: [id])

  // Status
  isCompleted  Boolean   @default(false)
  completedAt  DateTime?

  // Timestamps
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([activityType])
  @@index([status])
  @@index([ownerId])
  @@index([contactId])
  @@index([accountId])
  @@index([opportunityId])
  @@index([dueDate])
}

// ==================== AUDIT LOG ====================

model AuditLog {
  id          String   @id @default(uuid())

  // Who performed the action
  userId      String
  userName    String
  userEmail   String

  // What action was performed
  action      String   // CREATE, UPDATE, DELETE, EXPORT, LOGIN, LOGOUT
  entity      String   // Account, Contact, Quote, Order, Invoice, Activity, etc.
  entityId    String?  // SAP DocEntry or Prisma UUID

  // Details
  description String   // Human-readable description
  changes     Json?    // { field: { old: x, new: y } } for updates
  metadata    Json?    // Additional context (IP, company, etc.)

  // Context
  companyCode String   // CR, GT, SV, HN, PA
  ipAddress   String?

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([entityId])
  @@index([companyCode])
  @@index([createdAt])
}
